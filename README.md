MFtools README
================
Dan Puddephatt
2016-12-19

The MFtools library is used for investigating the input and output ffiles from MODFLOW simulations. The library is based on fixed-width file formats as are generated when using Groundwater Vistas. This library has been tested using Groundwater Vistas files. The library includes functions for the following tasks:

-   Reading the discritization file (readdis(rootname))
-   Reading the layer property flow file (readlpf(rootname))
-   Reading the basic transport package file (readbtn(rootname))
-   Reading the headsave file (readhds(rootname, NLAY, NTTS))
-   Reading the unformatted concentration file (readucn(ucrootname, NLAY, NTTS))
-   Reading no-flow array file (readnoflow(FILE, rootname))
-   Writing the unformatted concentration file based on a concentration dataframe (writeucn(ucn, ofl))

The library also includes a utility function for calculating contaminant mass based on information from the headsave file (i.e., saturated thickness), porosity read from the basic transport package, and concentrations from the unformatted concentration file (masscalc(BTN, HDS, UCN))

The package includes a set of MODFLOW files from the Texas Water Development Board (TWDB) Groundwater Availability Model (GAM) for the Edwards-Trinity (High Plains) Aquifer in Texas and New Mexico.

The functions from the MFtools library use rootnames to read files. Rootnames are based on the MODFLOW rootname convention such that files consist of a rootname and an extension that describes the MODFLOW file.

For the example using the TWDB GAM the rootname can be identified as follows (NOTE that by my personal convention my script headings include the libraries that I will be using):

``` r
library(MFtools)
library(tidyverse)
library(magrittr)
library(scales)
rnm <- system.file("extdata", "Ogll_sv2.01_ss.dis", package = "MFtools") %>%
        tools::file_path_sans_ext()
```

With the rootname we can now read in the discretization file

``` r
d <- readdis(rnm)
d
```

    ## $NLAY
    ## [1] 4
    ## 
    ## $NCOL
    ## [1] 290
    ## 
    ## $NROW
    ## [1] 270
    ## 
    ## $NPER
    ## [1] 20
    ## 
    ## $ITMUNI
    ## [1] 4
    ## 
    ## $LENUNI
    ## [1] 1
    ## 
    ## $LAYCBD
    ## [1] 0 0 0 0
    ## 
    ## $dX
    ##   [1] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ##  [15] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ##  [29] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ##  [43] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ##  [57] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ##  [71] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ##  [85] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ##  [99] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ## [113] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ## [127] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ## [141] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ## [155] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ## [169] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ## [183] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ## [197] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ## [211] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ## [225] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ## [239] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ## [253] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ## [267] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ## [281] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ## 
    ## $X
    ##   [1]    2640    7920   13200   18480   23760   29040   34320   39600
    ##   [9]   44880   50160   55440   60720   66000   71280   76560   81840
    ##  [17]   87120   92400   97680  102960  108240  113520  118800  124080
    ##  [25]  129360  134640  139920  145200  150480  155760  161040  166320
    ##  [33]  171600  176880  182160  187440  192720  198000  203280  208560
    ##  [41]  213840  219120  224400  229680  234960  240240  245520  250800
    ##  [49]  256080  261360  266640  271920  277200  282480  287760  293040
    ##  [57]  298320  303600  308880  314160  319440  324720  330000  335280
    ##  [65]  340560  345840  351120  356400  361680  366960  372240  377520
    ##  [73]  382800  388080  393360  398640  403920  409200  414480  419760
    ##  [81]  425040  430320  435600  440880  446160  451440  456720  462000
    ##  [89]  467280  472560  477840  483120  488400  493680  498960  504240
    ##  [97]  509520  514800  520080  525360  530640  535920  541200  546480
    ## [105]  551760  557040  562320  567600  572880  578160  583440  588720
    ## [113]  594000  599280  604560  609840  615120  620400  625680  630960
    ## [121]  636240  641520  646800  652080  657360  662640  667920  673200
    ## [129]  678480  683760  689040  694320  699600  704880  710160  715440
    ## [137]  720720  726000  731280  736560  741840  747120  752400  757680
    ## [145]  762960  768240  773520  778800  784080  789360  794640  799920
    ## [153]  805200  810480  815760  821040  826320  831600  836880  842160
    ## [161]  847440  852720  858000  863280  868560  873840  879120  884400
    ## [169]  889680  894960  900240  905520  910800  916080  921360  926640
    ## [177]  931920  937200  942480  947760  953040  958320  963600  968880
    ## [185]  974160  979440  984720  990000  995280 1000560 1005840 1011120
    ## [193] 1016400 1021680 1026960 1032240 1037520 1042800 1048080 1053360
    ## [201] 1058640 1063920 1069200 1074480 1079760 1085040 1090320 1095600
    ## [209] 1100880 1106160 1111440 1116720 1122000 1127280 1132560 1137840
    ## [217] 1143120 1148400 1153680 1158960 1164240 1169520 1174800 1180080
    ## [225] 1185360 1190640 1195920 1201200 1206480 1211760 1217040 1222320
    ## [233] 1227600 1232880 1238160 1243440 1248720 1254000 1259280 1264560
    ## [241] 1269840 1275120 1280400 1285680 1290960 1296240 1301520 1306800
    ## [249] 1312080 1317360 1322640 1327920 1333200 1338480 1343760 1349040
    ## [257] 1354320 1359600 1364880 1370160 1375440 1380720 1386000 1391280
    ## [265] 1396560 1401840 1407120 1412400 1417680 1422960 1428240 1433520
    ## [273] 1438800 1444080 1449360 1454640 1459920 1465200 1470480 1475760
    ## [281] 1481040 1486320 1491600 1496880 1502160 1507440 1512720 1518000
    ## [289] 1523280 1528560
    ## 
    ## $dY
    ##   [1] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ##  [15] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ##  [29] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ##  [43] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ##  [57] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ##  [71] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ##  [85] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ##  [99] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ## [113] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ## [127] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ## [141] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ## [155] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ## [169] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ## [183] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ## [197] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ## [211] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ## [225] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ## [239] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ## [253] 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280 5280
    ## [267] 5280 5280 5280 5280
    ## 
    ## $Y
    ##   [1] 1422960 1417680 1412400 1407120 1401840 1396560 1391280 1386000
    ##   [9] 1380720 1375440 1370160 1364880 1359600 1354320 1349040 1343760
    ##  [17] 1338480 1333200 1327920 1322640 1317360 1312080 1306800 1301520
    ##  [25] 1296240 1290960 1285680 1280400 1275120 1269840 1264560 1259280
    ##  [33] 1254000 1248720 1243440 1238160 1232880 1227600 1222320 1217040
    ##  [41] 1211760 1206480 1201200 1195920 1190640 1185360 1180080 1174800
    ##  [49] 1169520 1164240 1158960 1153680 1148400 1143120 1137840 1132560
    ##  [57] 1127280 1122000 1116720 1111440 1106160 1100880 1095600 1090320
    ##  [65] 1085040 1079760 1074480 1069200 1063920 1058640 1053360 1048080
    ##  [73] 1042800 1037520 1032240 1026960 1021680 1016400 1011120 1005840
    ##  [81] 1000560  995280  990000  984720  979440  974160  968880  963600
    ##  [89]  958320  953040  947760  942480  937200  931920  926640  921360
    ##  [97]  916080  910800  905520  900240  894960  889680  884400  879120
    ## [105]  873840  868560  863280  858000  852720  847440  842160  836880
    ## [113]  831600  826320  821040  815760  810480  805200  799920  794640
    ## [121]  789360  784080  778800  773520  768240  762960  757680  752400
    ## [129]  747120  741840  736560  731280  726000  720720  715440  710160
    ## [137]  704880  699600  694320  689040  683760  678480  673200  667920
    ## [145]  662640  657360  652080  646800  641520  636240  630960  625680
    ## [153]  620400  615120  609840  604560  599280  594000  588720  583440
    ## [161]  578160  572880  567600  562320  557040  551760  546480  541200
    ## [169]  535920  530640  525360  520080  514800  509520  504240  498960
    ## [177]  493680  488400  483120  477840  472560  467280  462000  456720
    ## [185]  451440  446160  440880  435600  430320  425040  419760  414480
    ## [193]  409200  403920  398640  393360  388080  382800  377520  372240
    ## [201]  366960  361680  356400  351120  345840  340560  335280  330000
    ## [209]  324720  319440  314160  308880  303600  298320  293040  287760
    ## [217]  282480  277200  271920  266640  261360  256080  250800  245520
    ## [225]  240240  234960  229680  224400  219120  213840  208560  203280
    ## [233]  198000  192720  187440  182160  176880  171600  166320  161040
    ## [241]  155760  150480  145200  139920  134640  129360  124080  118800
    ## [249]  113520  108240  102960   97680   92400   87120   81840   76560
    ## [257]   71280   66000   60720   55440   50160   44880   39600   34320
    ## [265]   29040   23760   18480   13200    7920    2640
    ## 
    ## $TOP
    ## # A tibble: 78,300 × 3
    ##      ROW   COL    TOP
    ##    <int> <dbl>  <dbl>
    ## 1      1     1 2368.4
    ## 2      1     2 2368.4
    ## 3      1     3 2368.4
    ## 4      1     4 2368.4
    ## 5      1     5 2368.4
    ## 6      1     6 2368.4
    ## 7      1     7 2368.4
    ## 8      1     8 2368.4
    ## 9      1     9 2368.4
    ## 10     1    10 2368.4
    ## # ... with 78,290 more rows
    ## 
    ## $BOT
    ## # A tibble: 313,200 × 4
    ##      LAY   ROW   COL    BOT
    ##    <int> <int> <dbl>  <dbl>
    ## 1      1     1     1 2363.4
    ## 2      1     1     2 2363.4
    ## 3      1     1     3 2363.4
    ## 4      1     1     4 2363.4
    ## 5      1     1     5 2363.4
    ## 6      1     1     6 2363.4
    ## 7      1     1     7 2363.4
    ## 8      1     1     8 2363.4
    ## 9      1     1     9 2363.4
    ## 10     1     1    10 2363.4
    ## # ... with 313,190 more rows
    ## 
    ## $PERLEN
    ##  [1] 364635 364635 364635 364635 364635 364635 364635 364635 364635 364635
    ## [11] 364635 364635 364635 364635 364635 364635 364635 364635 364635    365
    ## 
    ## $NSTP
    ##  [1] 999 999 999 999 999 999 999 999 999 999 999 999 999 999 999 999 999
    ## [18] 999 999   1
    ## 
    ## $TSMULT
    ##  [1] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
    ## 
    ## $SS
    ##  [1] "TR" "TR" "TR" "TR" "TR" "TR" "TR" "TR" "TR" "TR" "TR" "TR" "TR" "TR"
    ## [15] "TR" "TR" "TR" "TR" "TR" "TR"

The structure of the variable, d, is a list consisting of the information from the MODFLOW discretization file. For indexing purposes, some of the information is arranged in a dataframe, such as the TOP and BOT variables that describe the top and bottom elevations of each model layer.

MFtools includes a function to read the layer property flow file (.lpf).

``` r
p <- readlpf(rnm)
p
```

    ## $ILPFCB
    ## [1] 50
    ## 
    ## $HDRY
    ## [1] 999
    ## 
    ## $NPLPF
    ## [1] 0
    ## 
    ## $LAYTYP
    ## [1] 1 3 3 3
    ## 
    ## $LAYAVG
    ## [1] 0 0 0 0
    ## 
    ## $CHANI
    ## [1] 1 1 1 1
    ## 
    ## $LAYVKA
    ## [1] 0 0 0 0
    ## 
    ## $LAYWET
    ## [1] 1 1 1 1
    ## 
    ## $WETFCT
    ## [1] 1
    ## 
    ## $IWETIT
    ## [1] 2
    ## 
    ## $IHDWET
    ## [1] 0
    ## 
    ## $PARNAM
    ## character(0)
    ## 
    ## $PARTYP
    ## character(0)
    ## 
    ## $Parval
    ## numeric(0)
    ## 
    ## $NCLU
    ## integer(0)
    ## 
    ## $Layer
    ## NULL
    ## 
    ## $Mltarr
    ## NULL
    ## 
    ## $Zonarr
    ## NULL
    ## 
    ## $IZ
    ## NULL
    ## 
    ## $PROPS
    ## # A tibble: 313,200 × 10
    ##      LAY   ROW   COL    HK  HANI   VKA    Ss    Sy VKCBD WETDRY
    ##    <int> <int> <int> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl>
    ## 1      1     1     1   2.5    NA  0.25  0.15  0.15    NA      0
    ## 2      1     1     2   2.5    NA  0.25  0.15  0.15    NA      0
    ## 3      1     1     3   2.5    NA  0.25  0.15  0.15    NA      0
    ## 4      1     1     4   2.5    NA  0.25  0.15  0.15    NA      0
    ## 5      1     1     5   2.5    NA  0.25  0.15  0.15    NA      0
    ## 6      1     1     6   2.5    NA  0.25  0.15  0.15    NA      0
    ## 7      1     1     7   2.5    NA  0.25  0.15  0.15    NA      0
    ## 8      1     1     8   2.5    NA  0.25  0.15  0.15    NA      0
    ## 9      1     1     9   2.5    NA  0.25  0.15  0.15    NA      0
    ## 10     1     1    10   2.5    NA  0.25  0.15  0.15    NA      0
    ## # ... with 313,190 more rows

The .lpf file has lots of really useful information. We can isolate this information using the "$" indexing operation.

``` r
p$PROPS
```

    ## # A tibble: 313,200 × 10
    ##      LAY   ROW   COL    HK  HANI   VKA    Ss    Sy VKCBD WETDRY
    ##    <int> <int> <int> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl>
    ## 1      1     1     1   2.5    NA  0.25  0.15  0.15    NA      0
    ## 2      1     1     2   2.5    NA  0.25  0.15  0.15    NA      0
    ## 3      1     1     3   2.5    NA  0.25  0.15  0.15    NA      0
    ## 4      1     1     4   2.5    NA  0.25  0.15  0.15    NA      0
    ## 5      1     1     5   2.5    NA  0.25  0.15  0.15    NA      0
    ## 6      1     1     6   2.5    NA  0.25  0.15  0.15    NA      0
    ## 7      1     1     7   2.5    NA  0.25  0.15  0.15    NA      0
    ## 8      1     1     8   2.5    NA  0.25  0.15  0.15    NA      0
    ## 9      1     1     9   2.5    NA  0.25  0.15  0.15    NA      0
    ## 10     1     1    10   2.5    NA  0.25  0.15  0.15    NA      0
    ## # ... with 313,190 more rows

``` r
p$PROPS %>% group_by(LAY) %>% summarise(MIN = min(HK), MEDIAN = median(HK), MAX = max(HK))
```

    ## # A tibble: 4 × 4
    ##     LAY   MIN MEDIAN    MAX
    ##   <int> <dbl>  <dbl>  <dbl>
    ## 1     1 2.500    2.5 1374.9
    ## 2     2 0.001    2.5 1374.9
    ## 3     3 0.001    2.5 1374.9
    ## 4     4 2.500    2.5 1374.9

The model is a four layer model. Summarising does not give us a lot of information about the distribution of hydraulic conductivity values.

We can, instead, use ggplot to plot a histogram of hydraulic conductivity values by layer

``` r
p$PROPS %>% ggplot(aes(x = HK)) +
            geom_histogram(aes(y = (..count..)/tapply(..count.., ..PANEL.., sum)[..PANEL..]),
                colour = "black", 
                fill = "yellow", 
                alpha = 0.6) +
            scale_y_continuous(limits = c(0, 0.2), 
                breaks = seq(0, 0.2, 0.05), 
                labels = percent, 
                name = "FREQUENCY COUNT (PERCENT)") +   
            scale_x_log10(breaks = 10^(-10:10), 
                 minor_breaks = c(1:9 %o% 10^(-10:10)), 
                 labels = scales::trans_format("log10", math_format(10^.x))) +
            facet_wrap(~LAY, ncol = 1) +
            labs(x = "HYDRAULIC CONDUCTIVITY (FEET / DAY)") +
            theme_bw()
```

    ## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.

    ## Warning: Removed 4 rows containing missing values (geom_bar).

![](README_files/figure-markdown_github/HISTO_K-1.png)

We can also investigate groundwater elevations by model layer

``` r
h <- readhds(rnm, NLAY = d$NLAY, 1)
h %>% filter(GWE > 2000) %>% filter(GWE < 10000) %>%
            ggplot(aes(x = GWE)) +
            geom_histogram(aes(y = (..count..)/tapply(..count.., ..PANEL.., sum)[..PANEL..]),
                colour = "black", 
                fill = "blue", 
                alpha = 0.6) +
            scale_y_continuous(limits = c(0, 0.2), 
                breaks = seq(0, 0.2, 0.05), 
                labels = percent, 
                name = "FREQUENCY COUNT (PERCENT)") +   
            facet_wrap(~LAY, ncol = 1) +
            labs(x = "GROUNDWATER ELEVATION (FEET AMSL)") +
            theme_bw()
```

    ## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.

![](README_files/figure-markdown_github/GWE-1.png)
